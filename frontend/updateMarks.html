<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Faculty Marks Entry</title>
    <link href="./assets/css/output.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            background: #8B0000;
            background-image:
                radial-gradient(circle at 10% 20%, rgba(255, 0, 0, 0.4) 0%, transparent 70%),
                radial-gradient(circle at 90% 80%, rgba(255, 0, 0, 0.4) 0%, transparent 70%);
            min-height: 100vh;
        }

        .subject-card,
        .student-card {
            background-color: rgba(255, 255, 255, 0.9);
        }
    </style>
</head>

<body class="min-h-screen p-4">
    <div
        class="container mx-auto my-10 p-6 md:p-8 bg-white bg-opacity-90 backdrop-blur-lg rounded-2xl shadow-2xl max-w-6xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Faculty Marks Portal</h1>
            <p class="text-gray-600">Enter student marks for selected semester and section.</p>
        </header>

        <button onclick="goHome()"
            class="bg-gray-800 hover:bg-black text-white font-bold py-2 px-6 rounded-full shadow-lg">â¬… Back</button>
        <button id="report-btn" type="button"
            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow ml-200">
            View Report
        </button>

        <form id="marks-form" class="space-y-6 mt-10">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="section" class="block text-sm font-medium text-gray-700 mb-1">Section</label>
                    <select id="section"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-rose-500" required>
                        <option value="" disabled selected>Select Section</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                    </select>
                </div>

                <div>
                    <label for="semester" class="block text-sm font-medium text-gray-700 mb-1">Semester</label>
                    <select id="semester"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-rose-500" required>
                        <option value="" disabled selected>Select Semester</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                    </select>
                </div>

                <div>
                    <label for="subject" class="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                    <select id="subject"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-rose-500" required>
                        <option value="" disabled selected>Select Subject</option>
                    </select>
                </div>
            </div>

            <div id="students-container" class="space-y-6 mt-10 border-t pt-6">
                <p class="text-gray-500 text-center py-4">Please select Section, Semester and Subject to load students.
                </p>
            </div>
        </form>
    </div>

    <!-- ðŸ“Š Report Modal -->
    <div id="reportModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 shadow-2xl w-11/12 md:w-3/4 lg:w-1/2 relative">
            <h2 class="text-2xl font-bold mb-4 text-center">Subject Performance Report</h2>

            <div class="flex justify-between items-center mb-4">
                <div class="flex gap-3">
                    <button id="filterAll"
                        class="bg-gray-300 hover:bg-gray-400 text-black px-3 py-1 rounded">All</button>
                    <button id="filterPass"
                        class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded">Passed</button>
                    <button id="filterFail"
                        class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded">Failed</button>
                </div>
                <button id="downloadReport"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow">
                    â¬‡ Download Excel
                </button>
            </div>

            <div id="reportTableContainer" class="overflow-x-auto max-h-[400px] overflow-y-auto border rounded-lg">
                <table id="reportTable" class="w-full text-sm text-left border-collapse">
                    <thead class="bg-gray-200 text-gray-700">
                        <tr>
                            <th class="p-2 border">USN</th>
                            <th class="p-2 border">Name</th>
                            <th class="p-2 border">CIE 1</th>
                            <th class="p-2 border">CIE 2</th>
                            <th class="p-2 border">Internal</th>
                            <th class="p-2 border">External</th>
                            <th class="p-2 border">Total</th>
                            <th class="p-2 border">Result</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700"></tbody>
                </table>
            </div>

            <button onclick="closeReport()" class="absolute top-2 right-3 text-gray-700 text-xl font-bold">âœ•</button>
        </div>
    </div>


    <script>
        const sectionSelect = document.getElementById("section");
        const semesterSelect = document.getElementById("semester");
        const subjectSelect = document.getElementById("subject");
        const studentsContainer = document.getElementById("students-container");
        const formMessage = document.getElementById("form-message");
        const submitBtn = document.getElementById("submit-btn");

        let isEditing = false;
        let globalIsLab = false;

        sectionSelect.addEventListener("change", loadSubjects);
        semesterSelect.addEventListener("change", loadSubjects);
        subjectSelect.addEventListener("change", loadStudents);

        // âœ… Internal Marks Calculation (matches backend logic)
        function calculateInternal(cie1, cie2, lab, assignment, isLab) {
            const cieScaled = isLab
                ? Math.ceil(((cie1 + cie2) / 50) * 15)
                : Math.ceil(((cie1 + cie2) / 50) * 25);
            return cieScaled + lab + assignment;
        }

        // âœ… Result Calculation (P/F)
        function calculateResult(internal, external) {
            const total = internal + external;
            return internal >= 20 && external >= 18 && total >= 40 ? "P" : "F";
        }

        // âœ… Fetch faculty-assigned subjects
        async function loadSubjects() {
            const sem = semesterSelect.value;
            const section = sectionSelect.value;
            if (!sem || !section) return;

            subjectSelect.innerHTML = `<option selected disabled>Loading...</option>`;
            try {
                const res = await fetch(`/api/marks/faculty-subjects?sem=${sem}&section=${section}`, {
                    credentials: "include"
                });
                const data = await res.json();

                subjectSelect.innerHTML = `<option disabled selected>Select Subject</option>`;
                if (!data.length) {
                    subjectSelect.innerHTML = `<option disabled>No subjects assigned</option>`;
                    return;
                }
                data.forEach(sub => {
                    subjectSelect.innerHTML += `<option value="${sub.subject_code}">${sub.subject_name}</option>`;
                });
            } catch (err) {
                console.error("Error loading subjects:", err);
                subjectSelect.innerHTML = `<option disabled>Error loading</option>`;
            }
        }

        // âœ… Fetch students + marks
        async function loadStudents() {
            const sem = semesterSelect.value;
            const section = sectionSelect.value;
            const subject = subjectSelect.value;
            if (!sem || !section || !subject) return;

            studentsContainer.innerHTML = `<p class="text-gray-500 text-center py-4">Loading students...</p>`;

            try {
                const res = await fetch(`/api/marks/students-by-section?sem=${sem}&section=${section}`, {
                    credentials: "include",
                });
                const students = await res.json();

                if (!students.length) {
                    studentsContainer.innerHTML = `<p class="text-gray-500 text-center py-4">No students found.</p>`;
                    return;
                }

                // Add Lab toggle + Edit button header
                studentsContainer.innerHTML = `
      <div class="flex justify-between items-center mb-4">
        <div class="flex items-center gap-2">
          <label class="font-medium text-gray-700 text-sm">Lab Course:</label>
          <button id="lab-toggle" type="button"
            class="px-4 py-1 rounded-lg text-sm font-semibold bg-gray-300 hover:bg-gray-400 transition">
            OFF
          </button>
        </div>
        <button id="edit-btn" type="button"
          class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-6 rounded-lg shadow">
          Edit Marks
        </button>
      </div>
    `;

                const listContainer = document.createElement("div");
                studentsContainer.appendChild(listContainer);

                // Loop through students
                for (const st of students) {
                    const marksRes = await fetch(`/api/marks/${st.usn}`, { credentials: "include" });
                    let markData = {};
                    if (marksRes.ok) {
                        const marksJson = await marksRes.json();
                        const found = marksJson.subjects?.find(s => s.subject_code === subject);
                        if (found) markData = found;
                    }

                    const card = document.createElement("div");
                    card.className = "student-card p-4 rounded-lg border";
                    card.innerHTML = `
        <h2 class="font-bold text-gray-800 text-lg mb-2">${st.usn} - ${st.name}</h2>
        <input type="hidden" class="student-usn" value="${st.usn}">
        <div class="grid grid-cols-2 md:grid-cols-6 gap-3">
          <div>
            <label class="block text-xs font-medium text-gray-600">CIE 1 (25)</label>
            <input type="number" class="cie1 w-full p-2 border rounded-md text-center" min="0" max="25" value="${markData.cie1 || ""}" disabled>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-600">CIE 2 (25)</label>
            <input type="number" class="cie2 w-full p-2 border rounded-md text-center" min="0" max="25" value="${markData.cie2 || ""}" disabled>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-600">Lab (25)</label>
            <input type="number" class="lab w-full p-2 border rounded-md text-center" min="0" max="50" value="${markData.lab || ""}" disabled>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-600">Assignment</label>
            <input type="number" class="assessment w-full p-2 border rounded-md text-center" min="0" max="25" value="${markData.assignment || ""}" disabled>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-600">External (50)</label>
            <input type="number" class="external-marks w-full p-2 border rounded-md text-center" min="0" max="50" value="${markData.external || ""}" disabled>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-600">Result</label>
            <p class="final-result font-bold text-lg ${markData.result === 'P' ? 'text-green-600' : 'text-red-500'}">${markData.result || 'F'}</p>
          </div>
        </div>
        <div class="pt-2 flex gap-6 text-sm">
          <span class="text-gray-600">Internal: <strong class="internal-total">${markData.internal || 0}</strong></span>
          <span class="text-gray-600">Total: <strong class="total-marks">${markData.total || 0}</strong></span>
        </div>
      `;

                    listContainer.appendChild(card);
                }

                // âœ… Lab toggle
                document.getElementById("lab-toggle").addEventListener("click", (e) => {
                    e.preventDefault();
                    globalIsLab = !globalIsLab;
                    const btn = e.target;
                    btn.textContent = globalIsLab ? "ON" : "OFF";
                    btn.className = globalIsLab
                        ? "px-4 py-1 rounded-lg text-sm font-semibold bg-green-500 text-white hover:bg-green-600"
                        : "px-4 py-1 rounded-lg text-sm font-semibold bg-gray-300 hover:bg-gray-400";
                    document.querySelectorAll(".student-card").forEach(updateMarksRow);
                });

                // âœ… Edit / Save toggle
                document.getElementById("edit-btn").addEventListener("click", async (e) => {
                    e.preventDefault();
                    isEditing = !isEditing;

                    document.querySelectorAll(".student-card input[type='number']").forEach(inp => {
                        inp.disabled = !isEditing;
                    });

                    const btn = e.target;
                    if (isEditing) {
                        btn.textContent = "Save Marks";
                        btn.className = "bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-6 rounded-lg shadow";
                    } else {
                        await saveMarks();
                        btn.textContent = "Edit Marks";
                        btn.className = "bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-6 rounded-lg shadow";
                    }
                });

            } catch (err) {
                console.error("Error loading students:", err);
                studentsContainer.innerHTML = `<p class="text-red-500 text-center py-4">Error loading students.</p>`;
            }
        }

        // âœ… Recalculate and update marks row
        function updateMarksRow(card) {
            const cie1 = Number(card.querySelector(".cie1").value) || 0;
            const cie2 = Number(card.querySelector(".cie2").value) || 0;
            const lab = Number(card.querySelector(".lab").value) || 0;
            const assignment = Number(card.querySelector(".assessment").value) || 0;
            const internal = calculateInternal(cie1, cie2, lab, assignment, globalIsLab);
            const total = internal + external;
            const result = calculateResult(internal, external);

            card.querySelector(".internal-total").textContent = internal;
            card.querySelector(".total-marks").textContent = total;
            const external = Number(card.querySelector(".external-marks").value) || 0;
            const resultEl = card.querySelector(".final-result");
            resultEl.textContent = result;
            resultEl.className = `final-result font-bold text-lg ${result === "P" ? "text-green-600" : "text-red-500"}`;
        }

        // âœ… Save marks to backend
        async function saveMarks() {
            const sem = semesterSelect.value;
            const subject = subjectSelect.value;

            const students = Array.from(document.querySelectorAll(".student-card")).map(card => {
                const cie1 = Number(card.querySelector(".cie1").value) || 0;
                const cie2 = Number(card.querySelector(".cie2").value) || 0;
                const lab = Number(card.querySelector(".lab").value) || 0;
                const assignment = Number(card.querySelector(".assessment").value) || 0;
                const external = Number(card.querySelector(".external-marks").value) || 0;
                const internal = calculateInternal(cie1, cie2, lab, assignment, globalIsLab);
                const total = internal + external;
                const result = calculateResult(internal, external);

                return {
                    usn: card.querySelector(".student-usn").value,
                    code: subject,
                    cie1, cie2, lab, assignment, external,
                    internal, total, result, isLab: globalIsLab
                };
            });

            try {
                for (const st of students) {
                    const body = { usn: st.usn, semester: sem, subjects: [st] };
                    const res = await fetch("/api/marks", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(body),
                    });
                    if (!res.ok) throw new Error(`Error saving marks for ${st.usn}`);
                }
                alert("âœ… Marks saved successfully!");
            } catch (err) {
                console.error(err);
                alert("âŒ Error saving marks!", true);
            } finally {
                document.querySelectorAll(".student-card input[type='number']").forEach(inp => inp.disabled = true);
                isEditing = false;
            }
        }
        // ðŸ“Š Open Report Popup
        document.addEventListener("click", async (e) => {
            if (e.target.id === "report-btn") {
                const sem = semesterSelect.value;
                const section = sectionSelect.value;
                const subject = subjectSelect.value;

                if (!sem || !section || !subject) {
                    alert("Please select Semester, Section, and Subject first.");
                    return;
                }

                loadReport("ALL");
                document.getElementById("reportModal").classList.remove("hidden");

                // Filter buttons
                document.getElementById("filterAll").onclick = () => loadReport("ALL");
                document.getElementById("filterPass").onclick = () => loadReport("P");
                document.getElementById("filterFail").onclick = () => loadReport("F");
                document.getElementById("downloadReport").onclick = downloadExcel;
            }
        });

        async function loadReport(filter) {
            const sem = semesterSelect.value;
            const section = sectionSelect.value;
            const subject = subjectSelect.value;
            const tbody = document.querySelector("#reportTable tbody");

            tbody.innerHTML = `<tr><td colspan="6" class="text-center p-3 text-gray-500">Loading...</td></tr>`;

            const res = await fetch(`/api/marks/report?sem=${sem}&section=${section}&subject=${subject}&filter=${filter}`);
            const data = await res.json();

            if (!data.length) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center p-3 text-gray-500">No records found.</td></tr>`;
                return;
            }

            tbody.innerHTML = data.map(st => `
    <tr class="${st.result === 'P' ? 'bg-green-50' : 'bg-red-50'}">
      <td class="border p-2">${st.usn}</td>
      <td class="border p-2">${st.name}</td>
      <td class="border p-2">${st.cie1}</td>
      <td class="border p-2">${st.cie2}</td>
      <td class="border p-2">${st.internal}</td>
      <td class="border p-2">${st.external}</td>
      <td class="border p-2">${st.total}</td>
      <td class="border p-2 font-bold ${st.result === 'P' ? 'text-green-600' : 'text-red-600'}">${st.result}</td>
    </tr>
  `).join("");
        }

        function closeReport() {
            document.getElementById("reportModal").classList.add("hidden");
        }

        // ðŸ“¤ Download Excel using XLSX
        async function downloadExcel() {
            const sem = semesterSelect.value;
            const section = sectionSelect.value;
            const subject = subjectSelect.value;
            const res = await fetch(`/api/marks/report?sem=${sem}&section=${section}&subject=${subject}`);
            const data = await res.json();

            if (!data.length) {
                alert("No data to download!");
                return;
            }

            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Report");
            XLSX.writeFile(workbook, `Report_${subject}_${section}_Sem${sem}.xlsx`);
        }


        // âœ… Feedback message
        function showMessage(msg, isError = false) {
            formMessage.textContent = msg;
            formMessage.className = `text-sm font-medium ${isError ? "text-red-600" : "text-green-600"}`;
            setTimeout(() => (formMessage.textContent = ""), 3000);
        }

        // âœ… Go back
        function goHome() {
            window.location.href = "facultyHome.html";
        }
    </script>


</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notes & Resources</title>
  <link href="./assets/css/output.css" rel="stylesheet">
  <style>
    body {
      background-color: #111827;
      background-image: radial-gradient(circle at 1px 1px, rgba(255, 255, 255, 0.1) 1px, transparent 0);
      background-size: 20px 20px;
    }

    @keyframes gradientBG {
      0% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    select,
    option {
      color: black;
    }
  </style>
</head>

<body class="text-gray-900 flex flex-col items-center p-4 sm:p-6 relative">
  <!-- Back Button -->
  <button onclick="goHome()"
    class="bg-gray-800 hover:bg-black text-white text-sm font-bold w-20 lg:w-25 lg:mr-350 md:mr-150 mr-70 lg:ml-10 lg:py-2 lg:px-6 mt-5 h-10 rounded-full shadow-lg mb-5">
    Back
  </button>

  <div class="relative z-10 w-full max-w-4xl bg-white/15 p-6 sm:p-8 rounded-3xl shadow-2xl">
    <div class="flex flex-col md:flex-row items-center md:justify-between">
      <h1
        class="text-3xl sm:text-4xl md:text-5xl font-extrabold text-white text-center drop-shadow-lg lg:mr-40 break-words">
        Notes & Resources
      </h1>
    </div>

    <!-- Semester -->
    <div class="mt-6">
      <label class="font-semibold text-white">Select Semester:</label>
      <select id="semester"
        class="w-full p-3 mt-2 border-2 border-purple-300 rounded-lg bg-white focus:ring-2 focus:ring-purple-500">
        <option value="">-- Choose Semester --</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
      </select>
    </div>

    <!-- Section -->
    <div class="mt-4">
      <label class="font-semibold text-white">Select Section:</label>
      <select id="section" disabled
        class="w-full p-3 mt-2 border-2 border-purple-300 rounded-lg bg-gray-200 cursor-not-allowed">
        <option value="">-- Choose Section --</option>
        <option value="A">A</option>
        <option value="B">B</option>
        <option value="C">C</option>
      </select>
    </div>

    <!-- Subject -->
    <div class="mt-4">
      <label class="font-semibold text-white">Select Subject:</label>
      <select id="subject" disabled
        class="w-full p-3 mt-2 border-2 border-purple-300 rounded-lg bg-gray-200 cursor-not-allowed">
        <option value="">-- Choose Subject --</option>
      </select>
    </div>
  </div>

  <!-- Notes Grid -->
  <div id="notesWrapper" class="relative z-10 mt-8 w-full max-w-6xl mb-12 px-2 sm:px-4">
    <div id="notesList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 sm:gap-6"></div>
    <div id="emptyMessage" class="hidden flex items-center justify-center h-[30vh]">
      <div class="bg-red-100 text-red-700 px-6 py-3 rounded-lg shadow-lg text-base sm:text-lg font-bold">
        ðŸš« No documents uploaded yet for this subject.
      </div>
    </div>
  </div>

 <script>
  const semesterSelect = document.getElementById("semester");
  const sectionSelect = document.getElementById("section");
  const subjectSelect = document.getElementById("subject");
  const notesList = document.getElementById("notesList");
  const emptyMessage = document.getElementById("emptyMessage");

  // ðŸ”¹ Enable Section when Semester is chosen
  semesterSelect.addEventListener("change", () => {
    const hasSemester = !!semesterSelect.value;
    sectionSelect.disabled = !hasSemester;
    sectionSelect.classList.toggle("bg-gray-200", !hasSemester);
    subjectSelect.disabled = true;
    subjectSelect.classList.add("bg-gray-200");
    subjectSelect.innerHTML = '<option value="">-- Choose Subject --</option>';
    notesList.innerHTML = "";
    emptyMessage.classList.add("hidden");
  });

  // ðŸ”¹ Load subjects for students
  sectionSelect.addEventListener("change", async () => {
    subjectSelect.innerHTML = '<option value="">-- Choose Subject --</option>';
    notesList.innerHTML = "";
    emptyMessage.classList.add("hidden");

    const sem = semesterSelect.value;
    const sec = sectionSelect.value; // âœ… FIXED
    if (!sem || !sec) return;

    try {
      const res = await fetch(`/api/notes/student-subjects?semester=${sem}&section=${sec}`);
      if (!res.ok) throw new Error("Failed to load subjects");

      const subs = await res.json();

      if (subs.length > 0) {
        // âœ… Fetch number of notes per subject
        for (const sub of subs) {
          const countRes = await fetch(`/api/notes?semester=${sem}&section=${sec}&subject=${sub.subject_code}`);
          const files = await countRes.json();
          const count = files.length;

          const option = document.createElement("option");
          option.value = sub.subject_code;
          option.innerHTML = `
            ${sub.subject_name} 
            <span style="background:red;color:white;border-radius:50%;padding:2px 8px;font-size:12px;margin-left:6px;">
              ${count}
            </span>
          `;
          subjectSelect.appendChild(option);
        }

        subjectSelect.disabled = false;
        subjectSelect.classList.remove("bg-gray-200");
      } else {
        subjectSelect.disabled = true;
        subjectSelect.classList.add("bg-gray-200");
        alert("âš ï¸ No notes uploaded yet for this section.");
      }
    } catch (err) {
      console.error("ðŸ”¥ Error fetching subjects:", err);
      alert("Failed to load subjects!");
    }
  });

  // ðŸ”¹ Load notes when subject changes
  subjectSelect.addEventListener("change", async () => {
    const sem = semesterSelect.value;
    const sec = sectionSelect.value;
    const sub = subjectSelect.value;

    notesList.innerHTML = "";
    emptyMessage.classList.add("hidden");

    if (sem && sec && sub) {
      try {
        const res = await fetch(`/api/notes?semester=${sem}&section=${sec}&subject=${sub}`);
        if (!res.ok) throw new Error("Failed to load notes");

        const files = await res.json();

        if (files.length > 0) {
          files.forEach(note => {
            const card = document.createElement("div");
            card.className = "note-card bg-white/90 rounded-xl shadow-lg p-6 flex flex-col items-center justify-center transition-transform hover:scale-105";
            card.innerHTML = `
              <div class="text-5xl mb-3">ðŸ“„</div>
              <p class="text-gray-800 font-semibold mb-2 text-center break-words">${note.file_name}</p>
              <div class="flex gap-2 flex-wrap justify-center">
                <a href="/api/notes/${note.id}/download"
                   class="bg-indigo-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-indigo-700">
                   Download
                </a>
                <a href="/api/notes/${note.id}/preview" target="_blank"
                   class="bg-green-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-700">
                   Preview
                </a>
              </div>
            `;
            notesList.appendChild(card);
          });
        } else {
          emptyMessage.classList.remove("hidden");
        }
      } catch (err) {
        console.error("ðŸ”¥ Error fetching notes:", err);
        alert("Failed to load notes!");
      }
    }
  });

  function goHome() {
    window.location.href = "studentHome.html";
  }
</script>

</body>

</html>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Notes</title>
    <link href="./assets/css/output.css" rel="stylesheet">

    <style>
        body {
            background-color: #ef5125;
            background-image: radial-gradient(circle at 1px 1px, rgba(205, 205, 205, 0.5) 1px, transparent 0);
            background-size: 20px 20px;
        }

        select,
        input {
            color: black;
        }
    </style>
</head>

<body class="min-h-screen">

    <!-- Back Button -->
    <button onclick="goHome()"
        class="bg-gray-800 hover:bg-black text-white font-semibold py-2 px-6 m-4 rounded-full shadow-md transition">
        Back
    </button>

    <div class="max-w-3xl mx-auto mt-6 text-black">

        <!-- Upload Form Card -->
        <div class="bg-white/15 shadow-xl p-6 rounded-xl backdrop-blur-lg">
            <h2 class="text-2xl font-semibold text-center mb-6">Upload Notes</h2>

            <form id="uploadForm" class="space-y-5">

                <!-- Semester -->
                <div>
                    <label class="block mb-1 font-medium">Select Semester</label>
                    <select id="semester"
                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-700 focus:outline-none"
                        required>
                        <option value="">-- Choose Semester --</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                    </select>
                </div>

                <!-- Section -->
                <div>
                    <label class="block mb-1 font-medium">Select Section</label>
                    <select id="section"
                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-700 focus:outline-none"
                        required>
                        <option value="">-- Choose Section --</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                    </select>
                </div>

                <!-- Subject -->
                <div>
                    <label class="block mb-1 font-medium">Select Subject</label>
                    <select id="subject"
                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-700 focus:outline-none"
                        required>
                        <option value="">-- Choose Subject --</option>
                    </select>
                </div>

                <!-- File Upload -->
                <div>
                    <label class="block mb-1 font-medium">Upload Notes (PDF/DOC/PPT)</label>
                    <input type="file" id="file" name="file"
                        class="border border-gray-300 p-2 rounded-lg bg-gray-600 focus:ring-2 focus:ring-gray-700 w-60 focus:outline-none"
                        accept=".pdf,.doc,.docx,.ppt,.pptx" required>
                </div>

                <button type="submit"
                    class="w-full bg-gray-800 hover:bg-black text-white font-semibold py-2 rounded-lg transition">
                    Upload Notes
                </button>
            </form>
        </div>

        <!-- Uploaded Notes Section -->
        <div class="bg-white/95 shadow-xl p-6 rounded-xl mt-6 backdrop-blur-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-700">Uploaded Notes</h3>
                <button id="deleteAllBtn"
                    class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 text-sm rounded-lg disabled:opacity-40 disabled:cursor-not-allowed"
                    disabled>
                    Delete All
                </button>
            </div>

            <div id="notesContainer" class="text-gray-600">
                <p>Select Semester, Section & Subject to view notes.</p>
            </div>
        </div>
    </div>

    <script>
        const semesterSelect = document.getElementById("semester");
        const sectionSelect = document.getElementById("section");
        const subjectSelect = document.getElementById("subject");
        const notesContainer = document.getElementById("notesContainer");
        const deleteAllBtn = document.getElementById("deleteAllBtn");

        // üîπ Load subjects for the logged-in faculty
        async function loadSubjects() {
            const sem = semesterSelect.value;
            const section = sectionSelect.value;
            subjectSelect.innerHTML = '<option value="">-- Choose Subject --</option>';

            if (!sem || !section) return;

            try {
                const res = await fetch(`/api/notes/subjects?semester=${sem}&section=${section}`, {
                    credentials: "include",
                });

                if (!res.ok) {
                    const data = await res.json();
                    alert("‚ö†Ô∏è " + (data.message || "Unauthorized. Please log in as faculty."));
                    return;
                }

                const subjects = await res.json();

                if (subjects.length === 0) {
                    subjectSelect.innerHTML = '<option value="">No subjects assigned</option>';
                    return;
                }

                subjects.forEach(s => {
                    const option = document.createElement("option");
                    option.value = s.subject_code;
                    option.textContent = s.subject_name;
                    subjectSelect.appendChild(option);
                });
            } catch (err) {
                console.error("Error loading subjects:", err);
                alert("‚ùå Failed to load subjects. Make sure you are logged in and assigned to this section.");
            }
        }

        semesterSelect.addEventListener("change", loadSubjects);
        sectionSelect.addEventListener("change", loadSubjects);
        subjectSelect.addEventListener("change", renderNotes);

        // üîπ Upload file
        document.getElementById("uploadForm").addEventListener("submit", async function (e) {
            e.preventDefault();

            const semester = semesterSelect.value;
            const section = sectionSelect.value;
            const subject = subjectSelect.value;
            const fileInput = document.getElementById("file");
            const file = fileInput.files[0];

            if (!semester || !section || !subject || !file)
                return alert("Please fill all fields.");

            const formData = new FormData();
            formData.append("semester", semester);
            formData.append("section", section);
            formData.append("subject", subject);
            formData.append("file", file);

            try {
                const res = await fetch("/api/notes/upload", {
                    method: "POST",
                    body: formData,
                    credentials: "include",
                });

                const data = await res.json();
                if (!res.ok) throw new Error(data.message || "Upload failed");

                alert("‚úÖ " + data.message);
                fileInput.value = "";
                renderNotes();
            } catch (err) {
                console.error("Upload error:", err);
                alert("‚ùå Failed to upload note. Check if you are assigned to this subject.");
            }
        });

        // üîπ Render uploaded notes
        async function renderNotes() {
            const semester = semesterSelect.value;
            const section = sectionSelect.value;
            const subject = subjectSelect.value;

            notesContainer.innerHTML = "";

            if (!semester || !section || !subject) {
                notesContainer.innerHTML = "<p>Select Semester, Section & Subject to view notes.</p>";
                deleteAllBtn.disabled = true;
                return;
            }

            try {
                const res = await fetch(`/api/notes?semester=${semester}&section=${section}&subject=${subject}`);
                const notes = await res.json();

                if (notes.length === 0) {
                    notesContainer.innerHTML = "<p>No notes uploaded yet for this subject.</p>";
                    deleteAllBtn.disabled = true;
                    return;
                }

                deleteAllBtn.disabled = false;

                const list = document.createElement("ul");
                list.className = "space-y-3";

                notes.forEach(note => {
                    const li = document.createElement("li");
                    li.className = "flex justify-between items-center bg-gray-100 p-3 rounded-lg border border-gray-300";

                    li.innerHTML = `
                        <a href="/api/notes/${note.id}/preview" class="text-gray-800 font-medium hover:underline" target="_blank">${note.file_name}</a>
                        <button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 text-sm rounded-lg">Delete</button>
                    `;

                    li.querySelector("button").addEventListener("click", async () => {
                        if (confirm("Delete this file?")) {
                            await fetch(`/api/notes/${note.id}`, { method: "DELETE", credentials: "include" });
                            renderNotes();
                        }
                    });

                    list.appendChild(li);
                });

                notesContainer.appendChild(list);
            } catch {
                notesContainer.innerHTML = "<p class='text-red-600'>Failed to load notes.</p>";
            }
        }

        // üîπ Delete all notes
        deleteAllBtn.addEventListener("click", async () => {
            const semester = semesterSelect.value;
            const section = sectionSelect.value;
            const subject = subjectSelect.value;

            if (confirm("Delete ALL your notes for this subject?")) {
                await fetch(`/api/notes`, {
                    method: "DELETE",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ semester, section, subject }),
                    credentials: "include",
                });
                renderNotes();
            }
        });

        function goHome() {
            window.location.href = "facultyHome.html";
        }
    </script>
</body>

</html>
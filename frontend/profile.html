<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Profile</title>
    <link href="./assets/css/output.css" rel="stylesheet">

    <style>
        .modal-transition {
            transition: opacity 0.3s ease-in-out;
        }

        body {
            background-color: #ffe6ef;
            background-image: radial-gradient(circle at 1px 1px, rgba(255, 161, 186, 0.35) 1px, transparent 0);
            background-size: 20px 20px;
        }
    </style>
</head>

<body class="min-h-screen p-6 flex flex-col items-center">

    <!-- Back Btn -->
    <button onclick="goHome()"
        class="bg-gray-800 hover:bg-black text-white font-semibold py-2 px-6 rounded-full shadow-lg mb-6 transition">
        Back
    </button>

    <!-- ================= Student Profile Card ================= -->
    <section id="profile"
        class="bg-white w-full max-w-xl p-8 rounded-2xl shadow-xl border border-gray-200 backdrop-blur-xl text-center space-y-4">

        <!-- Avatar -->
        <div class="flex flex-col items-center">
            <div id="student-avatar"
                class="w-28 h-28 rounded-full bg-gray-600 flex items-center justify-center text-white text-3xl font-bold shadow-lg ring-4 ring-pink-200 overflow-hidden cursor-pointer transition hover:scale-105">
                ?
            </div>

            <input type="file" id="profilePhotoInput" accept="image/*" class="hidden"
                onchange="uploadProfilePhoto(event)">

            <button onclick="document.getElementById('profilePhotoInput').click()"
                class="mt-4 bg-gray-600 hover:bg-gray-700 text-white px-5 py-2 rounded-lg shadow transition">
                Upload Photo
            </button>
        </div>

        <h2 id="student-name" class="text-3xl font-bold text-gray-800 mt-4">Loading...</h2>

        <div class="text-gray-600 space-y-1">
            <p id="student-usn"></p>
            <p id="student-section"></p>
            <p id="student-sem"></p>
            <p id="student-phone"></p>
            <p id="student-email"></p>
        </div>

        <p id="class-advisor" class="text-gray-900 font-semibold mt-4">Class Advisor: Loading...</p>

        <!-- Buttons -->
        <div class="mt-8 flex flex-col items-center space-y-3">
            <button id="studentChangePass"
                class="bg-blue-500 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-600 transition w-48">
                Change Password
            </button>

            <form action="/logout" method="POST">
                <button type="submit"
                    class="bg-red-500 text-white px-6 py-2 rounded-lg shadow hover:bg-red-600 transition w-48">
                    Logout
                </button>
            </form>
        </div>
    </section>

    <!-- ================= Contact Section ================= -->
    <section id="contact"
        class="bg-white mt-10 w-full max-w-xl p-8 rounded-2xl shadow-xl border border-gray-200 backdrop-blur-xl text-center">

        <h2 class="text-3xl font-bold text-gray-800">Contact Us</h2>

        <input id="email" type="text" placeholder="Enter your email"
            class="mt-4 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 outline-none">

        <textarea id="message" placeholder="Your message"
            class="mt-4 w-full p-3 border border-gray-300 rounded-lg h-32 focus:ring-2 focus:ring-pink-500 outline-none"></textarea>

        <button type="button" onclick="sendMessage()"
            class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg shadow transition">
            Send Message
        </button>

        <div id="loading" class="w-12 h-12 mt-4 hidden mx-auto">
            <img src="./images/spinner.svg" alt="Loading..." class="w-full h-full">
        </div>
    </section>

    <!-- ================= Photo Modal ================= -->
    <div id="photoModal"
        class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 modal-transition"
        onclick="closePhotoModal()">
        <div class="relative bg-white rounded-full p-2 shadow-2xl" onclick="event.stopPropagation()">
            <img id="modalPhoto" src="" class="w-72 h-72 object-cover rounded-full shadow-lg">
            <button
                class="absolute top-0 right-0 -mt-3 -mr-3 bg-gray-800 text-white rounded-full w-8 h-8 flex items-center justify-center text-xl font-bold hover:bg-gray-700 transition"
                onclick="closePhotoModal()">&times;</button>
        </div>
    </div>

    <!-- ================= JS ================= -->
    <script>
        let currentPhotoUrl = null;

        async function loadProfile() {
            const ca = document.getElementById("class-advisor");

            try {
                const profileRes = await fetch("/api/profile");
                const profile = await profileRes.json();

                if (profile.error) return alert(profile.error);

                document.getElementById("student-name").textContent = profile.name;
                document.getElementById("student-usn").textContent = `USN: ${profile.usn}`;
                document.getElementById("student-section").textContent = `Section: ${profile.section}`;
                document.getElementById("student-sem").textContent = `Semester: ${profile.sem}`;
                document.getElementById("student-phone").textContent = `Phone: ${profile.phone}`;
                document.getElementById("student-email").textContent = `Email: ${profile.email}`;

                // Avatar logic
                const initials = profile.name.split(" ").map(w => w[0]).slice(0, 2).join("").toUpperCase();
                const avatar = document.getElementById("student-avatar");

                currentPhotoUrl = profile.photoUrl;

                if (currentPhotoUrl) {
                    avatar.innerHTML = `<img src="${currentPhotoUrl}" class="w-full h-full object-cover rounded-full">`;
                    avatar.style.cursor = "pointer";
                } else {
                    avatar.textContent = initials;
                    avatar.style.cursor = "default";
                }

                // Class Advisor
                ca.textContent = "Class Advisor: Fetching...";

                const caRes = await fetch(`/api/admin/class-advisor/${profile.section}`);
                const caData = await caRes.json();

                if (caRes.ok && caData.faculty_name) {
                    ca.textContent = `Class Advisor: ${caData.faculty_name}`;
                } else {
                    ca.textContent = "Class Advisor: Not yet assigned.";
                }

                document.getElementById("studentChangePass").onclick = () => {
                    window.location.href = "changepass.html";
                };

            } catch {
                ca.textContent = "Class Advisor: Network error.";
                alert("Failed to load profile.");
            }
        }

        async function uploadProfilePhoto(event) {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append("photo", file);

            try {
                const res = await fetch("/api/profile-photo", { method: "POST", body: formData });
                const data = await res.json();

                if (data.success) {
                    alert("Profile photo updated!");
                    loadProfile();
                } else {
                    alert(data.error || "Upload failed");
                }
            } catch {
                alert("Error uploading photo.");
            }
        }

        function openPhotoModal() {
            if (!currentPhotoUrl) return;
            document.getElementById("modalPhoto").src = currentPhotoUrl;
            document.getElementById("photoModal").classList.remove("hidden");
            document.body.style.overflow = "hidden";
        }

        function closePhotoModal() {
            document.getElementById("photoModal").classList.add("hidden");
            document.body.style.overflow = "";
        }

        async function sendMessage() {
            const email = document.getElementById("email").value;
            const msg = document.getElementById("message").value;
            const loader = document.getElementById("loading");

            if (!email || !msg) return alert("Please fill both email and message.");

            loader.classList.remove("hidden");

            try {
                const res = await fetch("/contact", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email, message: msg })
                });

                const data = await res.json();
                alert(data.success ? "Message sent!" : data.error);

                if (data.success) {
                    document.getElementById("email").value = "";
                    document.getElementById("message").value = "";
                }

            } catch {
                alert("Error sending message.");
            }

            loader.classList.add("hidden");
        }

        function goHome() {
            window.location.href = "studentHome.html";
        }

        document.addEventListener("DOMContentLoaded", loadProfile);
    </script>

</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Profile</title>
    <link href="./assets/css/output.css" rel="stylesheet">
    <style>
        /* Optional: Add a transition for a smoother modal appearance */
        .modal-transition {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>

<body class="bg-pink-50 min-h-screen flex flex-col items-center justify-center p-6">

    <section id="profile" class="bg-white rounded-xl shadow-lg p-8 w-full max-w-lg text-center space-y-4">
        <div id="student-avatar"
            class="w-24 h-24 mx-auto rounded-full bg-gray-800 flex items-center justify-center text-white text-3xl font-bold overflow-hidden cursor-pointer"
            onclick="openPhotoModal()">
            ?
        </div>
        <input type="file" id="profilePhotoInput" accept="image/*" class="hidden" onchange="uploadProfilePhoto(event)">
        <button onclick="document.getElementById('profilePhotoInput').click()"
            class="mt-2 bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-800">Upload Photo</button>

        <h2 class="text-2xl font-bold text-gray-700" id="student-name">Loading...</h2>
        <p id="student-usn" class="text-gray-600"></p>
        <p id="student-section" class="text-gray-600"></p>
        <p id="student-sem" class="text-gray-600"></p>

        <p id="class-advisor" class="text-gray-800 font-semibold mt-2">Class Advisor: Loading...</p>

        <p id="student-phone" class="text-gray-600"></p>
        <p id="student-email" class="text-gray-600"></p>

        <div class="mt-5 space-y-3">
            <button id="studentChangePass"
                class="bg-blue-500 text-white px-4 py-2 rounded w-40 hover:bg-blue-600">Change Password</button>
            <form action="/logout" method="POST">
                <button type="submit"
                    class="bg-red-500 text-white px-4 py-2 rounded w-40 hover:bg-red-600">Logout</button>
            </form>
        </div>
    </section>

    ---

    <section id="contact" class="bg-pink-100 mt-10 rounded-xl shadow-md p-8 w-full max-w-lg text-center">
        <h2 class="text-3xl font-bold leading-loose">Contact Us</h2>
        <input id="email" type="text" placeholder="Enter your email"
            class="mt-4 p-3 w-full border border-gray-300 rounded">
        <textarea id="message" placeholder="Your message"
            class="mt-4 p-3 border border-gray-300 rounded w-full h-32"></textarea>
        <button type="button" onclick="sendMessage()"
            class="mt-4 bg-blue-500 text-white px-6 py-3 rounded hover:bg-blue-600">Send Message</button>
        <div id="loading" class="w-12 h-12 mt-4 hidden mx-auto">
            <img src="./images/spinner.svg" alt="Loading..." class="w-full h-full">
        </div>
    </section>

    <div id="photoModal"
        class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 modal-transition"
        onclick="closePhotoModal()">
        <div class="relative bg-white rounded-full p-2" onclick="event.stopPropagation()">
            <img id="modalPhoto" src="" alt="Full Profile Photo" class="w-64 h-64 object-cover rounded-full">
            <button
                class="absolute top-0 right-0 -mt-2 -mr-2 bg-gray-800 text-white rounded-full w-8 h-8 flex items-center justify-center text-xl font-bold hover:bg-gray-700 transition-colors"
                onclick="closePhotoModal()">&times;</button>
        </div>
    </div>


    <script>
        let currentPhotoUrl = null; // Variable to store the current photo URL

        // --- Load Profile Data ---
        async function loadProfile() {
            const caElement = document.getElementById("class-advisor");

            try {
                // 1. Fetch Student Profile Data
                const profileRes = await fetch("/api/profile");
                const profileData = await profileRes.json();

                if (profileData.error) return alert(profileData.error);

                // Populate student details
                document.getElementById("student-name").textContent = profileData.name;
                document.getElementById("student-usn").textContent = `USN: ${profileData.usn}`;
                document.getElementById("student-section").textContent = `Section: ${profileData.section}`;
                document.getElementById("student-sem").textContent = `Semester: ${profileData.sem}`;
                document.getElementById("student-phone").textContent = `Phone: ${profileData.phone}`;
                document.getElementById("student-email").textContent = `Email: ${profileData.email}`;

                // Avatar Logic
                const initials = profileData.name.split(" ").map(w => w[0]?.toUpperCase()).slice(0, 2).join("");
                const avatar = document.getElementById("student-avatar");

                // Store the photo URL if it exists
                currentPhotoUrl = profileData.photoUrl;

                if (currentPhotoUrl) {
                    avatar.innerHTML = `<img src="${currentPhotoUrl}" alt="Profile Photo" class="w-full h-full object-cover rounded-full">`;
                    // Make sure the avatar is clickable only if a photo exists
                    avatar.style.cursor = 'pointer';
                } else {
                    avatar.textContent = initials || "?";
                    // Change cursor back to default if no photo is present
                    avatar.style.cursor = 'default';
                }

                // 2. Fetch Class Advisor Data based on student's section ðŸ’¡
                caElement.textContent = "Class Advisor: Fetching...";

                // Assumes backend route /api/class-advisor/:section exists
                const caRes = await fetch(`/api/admin/class-advisor/${profileData.section}`);
                const caData = await caRes.json();

                if (caRes.ok && caData.faculty_name) {
                    caElement.textContent = `Class Advisor: ${caData.faculty_name}`;
                } else if (caData.message) {
                    // This handles the case where the CA hasn't been assigned yet (e.g., status 404 or a custom success message)
                    caElement.textContent = `Class Advisor: Not yet assigned.`;
                } else {
                    caElement.textContent = `Class Advisor: Could not fetch details.`;
                }


                document.getElementById("studentChangePass").addEventListener("click", () => {
                    window.location.href = "changepass.html";
                });

            } catch (err) {
                console.error(err);
                // Set fallback text for profile and CA if initial fetch fails
                document.getElementById("student-name").textContent = "Error Loading Profile";
                caElement.textContent = "Class Advisor: Network error.";
                alert("Failed to load profile. Check server connection.");
            }
        }

        // --- Upload Profile Photo ---
        async function uploadProfilePhoto(event) {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append("photo", file);

            try {
                const res = await fetch("/api/profile-photo", { method: "POST", body: formData });
                const data = await res.json();

                if (data.success) {
                    alert("Profile photo updated!");
                    loadProfile(); // reload profile to show new photo
                } else {
                    alert(data.error || "Upload failed");
                }
            } catch (err) {
                console.error(err);
                alert("Error uploading photo");
            }
        }

        // --- Full Photo Modal Logic ---
        function openPhotoModal() {
            if (!currentPhotoUrl) {
                // Prevent opening if no photo is set (only initials are shown)
                return;
            }
            const modal = document.getElementById('photoModal');
            const modalPhoto = document.getElementById('modalPhoto');

            modalPhoto.src = currentPhotoUrl; // Set the full size image source
            modal.classList.remove('hidden'); // Show the modal
            document.body.style.overflow = 'hidden'; // Prevent scrolling the background
        }

        function closePhotoModal() {
            const modal = document.getElementById('photoModal');
            modal.classList.add('hidden'); // Hide the modal
            document.body.style.overflow = ''; // Restore background scrolling
        }


        // --- Contact Message ---
        async function sendMessage() {
            const email = document.getElementById('email').value;
            const message = document.getElementById('message').value;
            const loader = document.getElementById('loading');

            if (!email || !message) return alert("Please fill both email and message fields.");

            loader.classList.remove('hidden');

            try {
                const res = await fetch("/contact", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email, message })
                });
                const data = await res.json();
                if (data.success) {
                    alert("Message sent!");
                    document.getElementById('email').value = '';
                    document.getElementById('message').value = '';
                } else alert(data.error || "Failed to send message.");
            } catch (err) {
                console.error(err);
                alert("Error sending message.");
            } finally {
                loader.classList.add('hidden');
            }
        }

        // Initialize
        document.addEventListener("DOMContentLoaded", loadProfile);
    </script>
</body>

</html>